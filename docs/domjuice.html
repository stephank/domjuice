<!DOCTYPE html>  <html> <head>   <title>domjuice.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               domjuice.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <pre><code>DOMJuice early prototype, © 2011 Stéphan Kochen.
Made available under the MIT license.
http://stephank.github.com/domjuice
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Initial Setup</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Fetch this here for easy access, and in the rare case someone overrides the
Node name. (Perhaps by accident.)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">ELEMENT_NODE</span><span class="p">}</span> <span class="o">=</span> <span class="nx">Node</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Name of the attribute we set on elements to identify their clone after an
entire tree of template nodes has been cloned with <code>cloneNode</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">cidAttr = </span><span class="s1">&#39;data-domjuice-cid&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Attribute names that are template operations match this short regular
expression. (<code>section:=</code> and <code>content:=</code> are matched separately.)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">colonAssignRe = </span><span class="sr">/:$/</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>DOM tree iterator which traverses nodes in document order.</p>

<p>The callback receives the node, the index in the parent node, and
the original index, which may differ if nodes were removed.</p>

<p>The callback may return an optional string action to perform on the node:</p>

<ul>
<li><code>'skip'</code>: do not traverse children of this node.</li>
<li><code>'remove'</code>: remove this node.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">eachNode = </span><span class="nf">(rootNode, callback) -&gt;</span>
  <span class="nv">walker = </span><span class="nf">(element) -&gt;</span>
    <span class="p">{</span><span class="nx">childNodes</span><span class="p">}</span> <span class="o">=</span> <span class="nx">element</span>
    <span class="p">{</span><span class="nx">length</span><span class="p">}</span> <span class="o">=</span> <span class="nx">childNodes</span>
    <span class="nv">index = originalIndex = </span><span class="mi">0</span>
    <span class="k">while</span> <span class="nv">childNode = </span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">index</span><span class="o">++</span><span class="p">]</span>
      <span class="nx">originalIndex</span><span class="o">++</span>

      <span class="k">switch</span> <span class="nx">callback</span> <span class="nx">childNode</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">originalIndex</span>
        <span class="k">when</span> <span class="s1">&#39;skip&#39;</span>
          <span class="k">continue</span>
        <span class="k">when</span> <span class="s1">&#39;remove&#39;</span>
          <span class="nx">element</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">childNode</span>
          <span class="nx">index</span><span class="o">--</span><span class="p">;</span> <span class="nx">length</span><span class="o">--</span>
          <span class="k">continue</span>

      <span class="nx">walker</span> <span class="nx">childNode</span>
    <span class="k">return</span>

  <span class="k">switch</span> <span class="nx">callback</span> <span class="nx">rootNode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">when</span> <span class="s1">&#39;skip&#39;</span>   <span class="k">then</span> <span class="k">return</span>
    <span class="k">when</span> <span class="s1">&#39;remove&#39;</span> <span class="k">then</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Cannot remove the top node&quot;</span>

  <span class="nx">walker</span> <span class="nx">rootNode</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Context Adaptors</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Adaptors are used to access and listen for changes to properties on
different types of objects and collections.</p>

<p>Listening for changes works a bit differently form the <code>bind</code> methods in,
say, Backbone.js or jQuery. The <code>bind</code> methods of adaptors should return
a handle object or nothing. Handle objects are expected to have a <code>unbind</code>
method taking no parameters.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>The following is the default adaptor for regular JavaScript <code>Object</code>s and
<code>Array</code>s. It more or less doubles as the interface description.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">DefaultAdaptor =</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Check if this adaptor can handle the given object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">check: </span><span class="nf">(object) -&gt;</span> <span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Access or listen for changes to a property of an object. The value of the
property should be provided as-is. Truthy values will be stringified,
while falsy values will display as nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getProperty: </span><span class="nf">(object, property) -&gt;</span>
    <span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span>

  <span class="nv">bindProperty: </span><span class="nf">(object, property, handler) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Called by a <code>SectionManager</code> to access or listen for changes to a property
on an object. Regardless of the property value, the adaptor is responsible
for providing a collection-like view to the <code>SectionManager</code>.</p>

<p>For actual collections, these methods provide access to its items. For
all other types, a view of a single item should be provided for truthy
values, or an empty view otherwise.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getSection: </span><span class="nf">(object, property, iterator) -&gt;</span>
    <span class="nv">val = </span><span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">val</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span> <span class="o">and</span> <span class="nv">a = </span><span class="nx">getAdaptor</span> <span class="nx">val</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">getSectionInner</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">iterator</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">val</span>
      <span class="nx">iterator</span> <span class="nx">val</span><span class="p">,</span> <span class="mi">0</span>

  <span class="nv">bindSection: </span><span class="nf">(object, property, manager) -&gt;</span>
    <span class="nv">val = </span><span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">val</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span> <span class="o">and</span> <span class="nv">a = </span><span class="nx">getAdaptor</span> <span class="nx">val</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">bindSectionInner</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">manager</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>The above <code>*Section</code> methods may rely on another type of adaptor to handle
the property's value if it is an object. These methods are provided as
interface between the two adaptors.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getSectionInner: </span><span class="nf">(object, iterator) -&gt;</span>
    <span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">length</span><span class="o">?</span>
      <span class="nx">iterator</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">i</span> <span class="k">for</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">object</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">object</span>
      <span class="nx">iterator</span> <span class="nx">object</span><span class="p">,</span> <span class="mi">0</span>

  <span class="nv">bindSectionInner: </span><span class="nf">(object, manager) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>Adaptor Registry</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>List of registered adaptors.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">adaptors = </span><span class="p">[</span><span class="nx">DefaultAdaptor</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Retrieve the adaptor that can handle the given context object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">getAdaptor = </span><span class="nf">(object) -&gt;</span>
  <span class="k">for</span> <span class="nx">adaptor</span> <span class="k">in</span> <span class="nx">adaptors</span>
    <span class="k">return</span> <span class="nx">adaptor</span> <span class="k">if</span> <span class="nx">adaptor</span><span class="p">.</span><span class="nx">check</span> <span class="nx">object</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Register a new type of adaptor.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">registerAdaptor = </span><span class="nf">(adaptor) -&gt;</span>
  <span class="nx">adaptors</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">adaptor</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h3>Adaptor Helpers</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>These just wrap the <code>getAdaptor</code> dance.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">getProperty = </span><span class="nf">(object, property) -&gt;</span>
  <span class="nx">getAdaptor</span><span class="p">(</span><span class="nx">object</span><span class="p">).</span><span class="nx">getProperty</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">property</span>

<span class="nv">bindProperty = </span><span class="nf">(object, property, handler) -&gt;</span>
  <span class="nx">getAdaptor</span><span class="p">(</span><span class="nx">object</span><span class="p">).</span><span class="nx">bindProperty</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">handler</span>

<span class="nv">getSection = </span><span class="nf">(object, property, iterator) -&gt;</span>
  <span class="nx">getAdaptor</span><span class="p">(</span><span class="nx">object</span><span class="p">).</span><span class="nx">getSection</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">iterator</span>

<span class="nv">bindSection = </span><span class="nf">(object, property, manager) -&gt;</span>
  <span class="nx">getAdaptor</span><span class="p">(</span><span class="nx">object</span><span class="p">).</span><span class="nx">bindSection</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">manager</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h2>Template Operations</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Each of the following classes represent a template operation.</p>

<p>When building a template, these are dynamically subclassed. The subclasses
carry data on that specific template operation within the template.</p>

<p>When instantiating a template, these subclasses are then instantiated with
the actual element to update, and the section it belongs to.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h3>Property Watcher Common</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Base class used by <code>VarAttr</code> and <code>VarContent</code>, because they are both similar
in watching a property with a variable value.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">BaseVarProp</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Whether we will update after <code>initialFill</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">willUpdate: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Currently displaying the root or inner context value.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">innerValueSet: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Bind to the root and inner context properties on instantiation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@el, @s) -&gt;</span>
    <span class="vi">@listeners =</span>
      <span class="nv">context: </span><span class="nx">bindProperty</span> <span class="nx">@s</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span> <span class="nx">@propertyName</span><span class="p">,</span> <span class="nx">@contextSet</span>
      <span class="nv">root: </span><span class="nx">bindProperty</span> <span class="nx">@s</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="nx">@propertyName</span><span class="p">,</span> <span class="nx">@rootSet</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Unbind both listeners on finalize.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">finalize: </span><span class="o">-&gt;</span>
    <span class="nx">@listeners</span><span class="p">.</span><span class="nx">context</span><span class="o">?</span><span class="p">.</span><span class="nx">unbind</span><span class="p">()</span>
    <span class="nx">@listeners</span><span class="p">.</span><span class="nx">root</span><span class="o">?</span><span class="p">.</span><span class="nx">unbind</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Set the initial value of the attribute using <code>getProperty</code>.</p>

<p>Without any listeners we can unset <code>willUpdate</code>. We can also unset it if
the inner context is truthy right now, and there's no inner context
listener to change it into something else.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">initialFill: </span><span class="o">-&gt;</span>
    <span class="nv">val = </span><span class="nx">getProperty</span> <span class="nx">@s</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span> <span class="nx">@propertyName</span>
    <span class="k">if</span> <span class="vi">@innerValueSet = </span><span class="o">!!</span><span class="nx">val</span>
      <span class="nx">@set</span> <span class="nx">val</span>
      <span class="nx">unless</span> <span class="vi">@willUpdate = </span><span class="nx">@listeners</span><span class="p">.</span><span class="nx">context</span><span class="o">?</span>
        <span class="nx">@listeners</span><span class="p">.</span><span class="nx">root</span><span class="o">?</span><span class="p">.</span><span class="nx">unbind</span><span class="p">()</span>
        <span class="vi">@listeners.root = </span><span class="kc">null</span>
    <span class="k">else</span>
      <span class="nx">@set</span> <span class="nx">getProperty</span> <span class="nx">@s</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="nx">@propertyName</span>
      <span class="vi">@willUpdate = </span><span class="nx">@listeners</span><span class="p">.</span><span class="nx">context</span><span class="o">?</span> <span class="o">or</span> <span class="nx">@listeners</span><span class="p">.</span><span class="nx">root</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Update triggered by the inner context. If there's a value, just set it
without fussing. If the value is falsy, we need to show root's.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">contextSet: </span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">value</span>
      <span class="nx">@set</span> <span class="nx">value</span>
      <span class="vi">@innerValueSet = </span><span class="kc">yes</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@innerValueSet</span>
      <span class="nx">@set</span> <span class="nx">getProperty</span> <span class="nx">@s</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="nx">@propertyName</span>
      <span class="vi">@innerValueSet = </span><span class="kc">no</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Update triggered by the root context. Only set the value if we're not
currently displaying an inner contexts value.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rootSet: </span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@set</span> <span class="nx">value</span> <span class="nx">unless</span> <span class="nx">@innerValueSet</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Set helper which does the actual update based on a value.
Subclasses override this to set an attribute or an element's content.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">set: </span><span class="nf">(value) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h3>Variable Attribute</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Manages an element attribute with a variable value.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">VarAttr</span> <span class="k">extends</span> <span class="nx">BaseVarProp</span>
  <span class="nv">set: </span><span class="nf">(value) -&gt;</span>
    <span class="nx">@el</span><span class="p">.</span><span class="nx">setAttribute</span> <span class="nx">@attrName</span><span class="p">,</span> <span class="nb">String</span> <span class="nx">value</span> <span class="o">or</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h3>Variable Content</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Manages an element with variable content.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">VarContent</span> <span class="k">extends</span> <span class="nx">BaseVarProp</span>
  <span class="nv">set: </span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">textNode = </span><span class="nx">@el</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">createTextNode</span> <span class="nb">String</span> <span class="nx">value</span> <span class="o">or</span> <span class="s1">&#39;&#39;</span>
    <span class="vi">@el.innerHTML = </span><span class="s1">&#39;&#39;</span>
    <span class="nx">@el</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">textNode</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <h3>Partial Content</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Invokes a partial and sets the element content to it. Partials need not be
DOMJuice templates, they can just as well be anything else that exposes an
attribute <code>el</code> with the DOM <code>Element</code>. Other than that, DOMJuice only looks
for the optional <code>finalize</code> method.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">PartialContent</span>
  <span class="nv">constructor: </span><span class="nf">(@el, @s) -&gt;</span>
    <span class="nv">klass = </span><span class="nx">DOMJuice</span><span class="p">.</span><span class="nx">partials</span><span class="p">[</span><span class="nx">@partialName</span><span class="p">]</span>
    <span class="vi">@partial = </span><span class="k">new</span> <span class="nx">klass</span> <span class="nx">@s</span><span class="p">.</span><span class="nx">context</span>

  <span class="nv">finalize: </span><span class="o">-&gt;</span>
    <span class="nx">@partial</span><span class="p">.</span><span class="nx">finalize</span><span class="o">?</span><span class="p">()</span>

  <span class="nv">initialFill: </span><span class="o">-&gt;</span>
    <span class="vi">@el.innerHTML = </span><span class="s1">&#39;&#39;</span>
    <span class="nx">@el</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">@partial</span><span class="p">.</span><span class="nx">el</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <h3>Section</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>The glue between parent and child sections. All sections, except the
template toplevel, are managed by one of these.</p>

<p>Methods of this class are used by context adaptors to update the instances
of the section.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">SectionManager</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Currently displaying the root or inner context value.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">innerValueSet: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Bind to the root and inner context properties on instantiation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@el, @s) -&gt;</span>
    <span class="vi">@sections = </span><span class="p">[]</span>

    <span class="vi">@listeners = </span><span class="p">{}</span>
    <span class="vi">@listeners.context = </span><span class="nx">bindSection</span> <span class="nx">@s</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span> <span class="nx">@propertyName</span><span class="p">,</span>
        <span class="nv">add: </span><span class="nx">@contextAdd</span><span class="p">,</span> <span class="nv">remove: </span><span class="nx">@contextRemove</span><span class="p">,</span> <span class="nv">refresh: </span><span class="nx">@contextRefresh</span>
    <span class="vi">@listeners.root = </span><span class="nx">bindSection</span> <span class="nx">@s</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="nx">@propertyName</span><span class="p">,</span>
        <span class="nv">add: </span><span class="nx">@rootAdd</span><span class="p">,</span> <span class="nv">remove: </span><span class="nx">@rootRemove</span><span class="p">,</span> <span class="nv">refresh: </span><span class="nx">@rootRefresh</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Unbind both listeners on finalize.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">finalize: </span><span class="o">-&gt;</span>
    <span class="nx">@listeners</span><span class="p">.</span><span class="nx">context</span><span class="o">?</span><span class="p">.</span><span class="nx">unbind</span><span class="p">()</span>
    <span class="nx">@listeners</span><span class="p">.</span><span class="nx">root</span><span class="o">?</span><span class="p">.</span><span class="nx">unbind</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Create the initial sections using <code>getSection</code>.</p>

<p>As with <code>BaseVarProp#initialFill</code>, if there are sections at this point,
and there is no inner context listener to change that, we can ditch the
root context listener.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">initialFill: </span><span class="o">-&gt;</span>
    <span class="nx">getSection</span> <span class="nx">@s</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span> <span class="nx">@propertyName</span><span class="p">,</span> <span class="nx">@add</span>
    <span class="k">if</span> <span class="vi">@innerValueSet = </span><span class="nx">@sections</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="nx">unless</span> <span class="nx">@listeners</span><span class="p">.</span><span class="nx">context</span><span class="o">?</span>
        <span class="nx">@listeners</span><span class="p">.</span><span class="nx">root</span><span class="o">?</span><span class="p">.</span><span class="nx">unbind</span><span class="p">()</span>
        <span class="vi">@listeners.root = </span><span class="kc">null</span>
    <span class="k">else</span>
      <span class="nx">getSection</span> <span class="nx">@s</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="nx">@propertyName</span><span class="p">,</span> <span class="nx">@add</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Update triggered by the inner context. Override the root context if it
was current, otherwise just add as normal.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">contextAdd: </span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">@innerValueSet</span>
      <span class="nx">@add</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">index</span>
    <span class="k">else</span>
      <span class="vi">@innerValueSet = </span><span class="kc">yes</span>
      <span class="nx">@refresh</span> <span class="nf">(iter) -&gt;</span>
        <span class="nx">iter</span> <span class="nx">item</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Update triggered by the root context. Add only if it is current.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rootAdd: </span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@add</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">index</span> <span class="nx">unless</span> <span class="nx">@innerValueSet</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Helper to create a section for the given item at the given index. If the
item is an object, the section will descend into it as a subcontext.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">add: </span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">section = </span><span class="k">new</span> <span class="nx">@sectionClass</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">@s</span>
    <span class="nv">refNode = </span><span class="nx">@el</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">@containerIndex</span> <span class="o">+</span> <span class="nx">index</span><span class="p">]</span> <span class="o">or</span> <span class="kc">null</span>
    <span class="nx">@el</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="nx">section</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span> <span class="nx">refNode</span>
    <span class="nx">@adjustNeighbours</span> <span class="o">+</span><span class="mi">1</span>
    <span class="nx">@sections</span><span class="p">.</span><span class="nx">splice</span> <span class="nx">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">section</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Update triggered by the inner context. Make the root context current if
this was the last item.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">contextRemove: </span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">@sections</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
      <span class="vi">@innerValueSet = </span><span class="kc">no</span>
      <span class="nx">@refresh</span> <span class="p">(</span><span class="nx">iter</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">getSection</span> <span class="nx">@s</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="nx">@propertyName</span><span class="p">,</span> <span class="nx">iter</span>
    <span class="k">else</span>
      <span class="nx">@remove</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">index</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Update triggered by the root context. Remove only if it is current.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rootRemove: </span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@remove</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">index</span> <span class="nx">unless</span> <span class="nx">@innerValueSet</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Helper to remove the section at the given index.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">remove: </span><span class="nf">(index) -&gt;</span>
    <span class="p">[</span><span class="nx">section</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@sections</span><span class="p">.</span><span class="nx">splice</span> <span class="nx">index</span><span class="p">,</span> <span class="mi">1</span>
    <span class="nx">section</span><span class="p">.</span><span class="nx">finalize</span><span class="p">()</span>
    <span class="nx">@el</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">@el</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">@containerIndex</span> <span class="o">+</span> <span class="nx">index</span><span class="p">]</span>
    <span class="nx">@adjustNeighbours</span> <span class="o">-</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Update triggered by the inner context. Make the root context current if
there are no items after the refresh.</p>

<p>FIXME: Perhaps a more efficient way of doing this?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">contextRefresh: </span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@refresh</span> <span class="nx">block</span>
    <span class="nx">unless</span> <span class="vi">@innerValueSet = </span><span class="nx">@sections</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="nx">@refresh</span> <span class="p">(</span><span class="nx">iter</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">getSection</span> <span class="nx">@s</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="nx">@propertyName</span><span class="p">,</span> <span class="nx">iter</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Update triggered by the root context. Refresh only if it is current.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rootRefresh: </span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@refresh</span> <span class="nx">block</span> <span class="nx">unless</span> <span class="nx">@innerValueSet</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Helper to replace all sections in one shot. The parameter is a function
that takes an iterator function. The iterator function is then called
repeatedly by the caller for each new item.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">refresh: </span><span class="nf">(block) -&gt;</span>
    <span class="k">for</span> <span class="nx">section</span> <span class="k">in</span> <span class="nx">@sections</span>
      <span class="nx">section</span><span class="p">.</span><span class="nx">finalize</span><span class="p">()</span>
      <span class="nx">@el</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">@el</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">@containerIndex</span><span class="p">]</span>
    <span class="nv">adjustment = </span><span class="o">-</span><span class="nx">@sections</span><span class="p">.</span><span class="nx">length</span>
    <span class="vi">@sections = </span><span class="p">[]</span>

    <span class="nv">refNode = </span><span class="nx">@el</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">@containerIndex</span><span class="p">]</span> <span class="o">or</span> <span class="kc">null</span>
    <span class="nx">block</span> <span class="nf">(item) -&gt;</span>
      <span class="nx">@sections</span><span class="p">.</span><span class="nx">push</span> <span class="nv">section = </span><span class="k">new</span> <span class="nx">@sectionClass</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">@s</span>
      <span class="nx">@el</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="nx">section</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span> <span class="nx">refNode</span>
    <span class="nx">adjustment</span> <span class="o">+=</span> <span class="nx">@sections</span><span class="p">.</span><span class="nx">length</span>

    <span class="nx">@adjustNeighbours</span> <span class="nx">adjustment</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Helper used to adjust the <code>containerIndex</code> of neighbours.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">adjustNeighbours: </span><span class="nf">(adjustment) -&gt;</span>
    <span class="k">for</span> <span class="nx">op</span> <span class="k">in</span> <span class="nx">@s</span><span class="p">.</span><span class="nx">opsByCid</span><span class="p">[</span><span class="nx">@cid</span><span class="p">]</span> <span class="k">when</span> <span class="nx">op</span><span class="p">.</span><span class="nx">containerOrder</span> <span class="o">&gt;</span> <span class="nx">@containerOrder</span>
      <span class="nx">op</span><span class="p">.</span><span class="nx">containerIndex</span> <span class="o">+=</span> <span class="nx">adjustment</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <h2>Section</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>A section can be the toplevel of a template (the actual template class the
user receives as the result of <code>DOMJuice(...)</code>), a template part that is
displayed conditionally, or a template part instantiated several times for
a collection.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Section</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Construct a section by giving it a context object. (The <code>parent</code> parameter
is for internal use only.)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@context={}, parent) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Set up the context for this section. If this is the toplevel, we expect
the user to give us an object. If it's an internal subsection, a
non-object indicates a simple conditional section, which means we just
continue in our parents context.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="k">typeof</span> <span class="nx">@context</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Template context should be an object&quot;</span> <span class="nx">unless</span> <span class="nx">parent</span>
      <span class="vi">@context = </span><span class="nx">parent</span><span class="p">.</span><span class="nx">context</span>
    <span class="vi">@root = </span><span class="nx">parent</span><span class="o">?</span><span class="p">.</span><span class="nx">root</span> <span class="o">or</span> <span class="nx">@context</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Deep clone the template nodes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@el = </span><span class="nx">@template</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Find elements that have been marked with a cid.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">ops = </span><span class="k">new</span> <span class="nb">Array</span> <span class="nx">@opsByCid</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">eachNode</span> <span class="nx">@el</span><span class="p">,</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">is</span> <span class="nx">ELEMENT_NODE</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nv">attribute = </span><span class="nx">node</span><span class="p">.</span><span class="nx">getAttributeNode</span> <span class="nx">cidAttr</span>
      <span class="nv">cid = </span><span class="nb">parseInt</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">nodeValue</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">removeAttributeNode</span> <span class="nx">attribute</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Instantiate all template operations for this node.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">klasses = </span><span class="nx">@opsByCid</span><span class="p">[</span><span class="nx">cid</span><span class="p">]</span>
      <span class="nx">ops</span><span class="p">[</span><span class="nx">cid</span><span class="p">]</span> <span class="o">=</span> <span class="k">for</span> <span class="nx">klass</span> <span class="k">in</span> <span class="nx">klasses</span>
        <span class="k">new</span> <span class="nx">klass</span> <span class="nx">node</span><span class="p">,</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Perform the initial fill for this section. Remove operations which will
never update again, so they will be garbage collected.</p>

<p><code>SectionManager</code>s need access to their neighbours, so expose the
operations. Shadow <code>opsByCid</code>, because there's no need to access supers.</p>

<p>FIXME: Do we want to try clean up non-<code>BaseVarProp</code>s here too?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@opsByCid = </span><span class="k">for</span> <span class="nx">elementOps</span> <span class="k">in</span> <span class="nx">ops</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">op</span> <span class="k">in</span> <span class="nx">elementOps</span>
      <span class="nx">op</span><span class="p">.</span><span class="nx">initialFill</span><span class="p">()</span>
      <span class="nx">op</span> <span class="nx">unless</span> <span class="nx">op</span> <span class="k">instanceof</span> <span class="nx">BaseVarProp</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">op</span><span class="p">.</span><span class="nx">willUpdate</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>DOMJuice templates require cleaning up, to clear back-references that are
kept by event listeners installed on context objects. Properly calling
<code>finalize</code> will ensure the template instance can be garbage collected.</p>

<p>Note that this does <strong>not</strong> remove the elements from the DOM. It is
expected they will be replaced any way, otherwise remove them manually.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">finalize: </span><span class="o">-&gt;</span>
    <span class="k">for</span> <span class="nx">cid</span><span class="p">,</span> <span class="nx">elementOps</span> <span class="k">of</span> <span class="nx">@opsByCid</span>
      <span class="k">for</span> <span class="nx">op</span> <span class="k">in</span> <span class="nx">elementOps</span>
        <span class="nx">op</span><span class="p">.</span><span class="nx">finalize</span><span class="p">()</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>The workhorse that builds Section subclasses for templates or subsections.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">buildSectionClass = </span><span class="nf">(template) -&gt;</span>
  <span class="nv">opsByCid = </span><span class="p">[]</span>
  <span class="nv">section = </span><span class="k">class</span> <span class="k">extends</span> <span class="nx">Section</span>
    <span class="nv">template: </span><span class="nx">template</span>
    <span class="nv">opsByCid: </span><span class="nx">opsByCid</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>The various operations we support are tagged to the element using
a <code>cid</code>. This is simply a unique ID that persists across <code>cloneNode</code>.
This helper tags an operation to an element.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">addOpToElement = </span><span class="nf">(element, op) -&gt;</span>
    <span class="k">if</span> <span class="nv">attribute = </span><span class="nx">element</span><span class="p">.</span><span class="nx">getAttributeNode</span> <span class="nx">cidAttr</span>
      <span class="nv">cid = </span><span class="nb">parseInt</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">nodeValue</span>
      <span class="nx">opsByCid</span><span class="p">[</span><span class="nx">cid</span><span class="p">].</span><span class="nx">push</span> <span class="nx">op</span>
    <span class="k">else</span>
      <span class="nv">cid = </span><span class="nb">String</span> <span class="nx">opsByCid</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">setAttribute</span> <span class="nx">cidAttr</span><span class="p">,</span> <span class="nx">cid</span>
      <span class="nx">opsByCid</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span><span class="nx">op</span><span class="p">]</span>
    <span class="nv">op::cid = </span><span class="nx">cid</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Walk the tree, extract sections, collect operations.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">eachNode</span> <span class="nx">template</span><span class="p">,</span> <span class="nf">(node, index, originalIndex) -&gt;</span>
    <span class="k">return</span> <span class="s1">&#39;skip&#39;</span> <span class="nx">unless</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">is</span> <span class="nx">ELEMENT_NODE</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Check for a <code>section:=</code> operation first. Other operations on the
sectioned element execute within the section context, and are
processed by a recursive <code>buildSectionClass</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">attribute = </span><span class="nx">node</span><span class="p">.</span><span class="nx">getAttributeNode</span> <span class="s1">&#39;section:&#39;</span>
      <span class="k">if</span> <span class="nx">node</span> <span class="o">is</span> <span class="nx">template</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Template root element cannot be a section&quot;</span>
      <span class="p">{</span><span class="nx">nodeValue</span><span class="p">}</span> <span class="o">=</span> <span class="nx">attribute</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">removeAttributeNode</span> <span class="nx">attribute</span>

      <span class="nx">addOpToElement</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="k">class</span> <span class="k">extends</span> <span class="nx">SectionManager</span>
        <span class="nv">propertyName: </span><span class="nx">nodeValue</span>
        <span class="nv">sectionClass: </span><span class="nx">buildSectionClass</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
        <span class="nv">containerIndex: </span><span class="nx">index</span>
        <span class="nv">containerOrder: </span><span class="nx">originalIndex</span>

      <span class="k">return</span> <span class="s1">&#39;remove&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Check for a <code>content:=</code> operation, and skip the contents of the element
if found. Content may be there as a design placeholder.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">attribute = </span><span class="nx">node</span><span class="p">.</span><span class="nx">getAttributeNode</span> <span class="s1">&#39;content:&#39;</span>
      <span class="p">{</span><span class="nx">nodeValue</span><span class="p">}</span> <span class="o">=</span> <span class="nx">attribute</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">removeAttributeNode</span> <span class="nx">attribute</span>

      <span class="k">if</span> <span class="nx">nodeValue</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;@&#39;</span>
        <span class="nx">addOpToElement</span> <span class="nx">node</span><span class="p">,</span> <span class="k">class</span> <span class="k">extends</span> <span class="nx">PartialContent</span>
          <span class="nv">partialName: </span><span class="nx">nodeValue</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">addOpToElement</span> <span class="nx">node</span><span class="p">,</span> <span class="k">class</span> <span class="k">extends</span> <span class="nx">VarContent</span>
          <span class="nv">propertyName: </span><span class="nx">nodeValue</span>

      <span class="nv">action = </span><span class="s1">&#39;skip&#39;</span>
 
    <span class="k">else</span>
      <span class="nv">action = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>All other <code>:=</code> operations set variable attributes on the element.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">{</span><span class="nx">attributes</span><span class="p">}</span> <span class="o">=</span> <span class="nx">node</span>
    <span class="p">{</span><span class="nx">length</span><span class="p">}</span> <span class="o">=</span> <span class="nx">attributes</span>
    <span class="nv">index = </span><span class="mi">0</span>
    <span class="k">while</span> <span class="nv">attribute = </span><span class="nx">attributes</span><span class="p">[</span><span class="nx">index</span><span class="o">++</span><span class="p">]</span>
      <span class="p">{</span><span class="nx">nodeName</span><span class="p">,</span> <span class="nx">nodeValue</span><span class="p">}</span> <span class="o">=</span> <span class="nx">attribute</span>
      <span class="k">continue</span> <span class="nx">unless</span> <span class="nx">colonAssignRe</span><span class="p">.</span><span class="nx">test</span> <span class="nx">nodeName</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">removeAttributeNode</span> <span class="nx">attribute</span>
      <span class="nx">index</span><span class="o">--</span><span class="p">;</span> <span class="nx">length</span><span class="o">--</span>

      <span class="nv">nodeName = </span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">slice</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
      <span class="nx">addOpToElement</span> <span class="nx">node</span><span class="p">,</span> <span class="k">class</span> <span class="k">extends</span> <span class="nx">VarAttr</span>
        <span class="nv">attrName: </span><span class="nx">nodeName</span>
        <span class="nv">propertyName: </span><span class="nx">nodeValue</span>

    <span class="k">return</span> <span class="nx">action</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Return the new section.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">section</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <h2>API</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Construct a template from the given input.
The input can be a string of markup, or a DOM <code>Element</code>.</p>

<p>When passing in an <code>Element</code>, it will be detached from the document and
any parent element. It shouldn't be referenced or used afterwards;
ownership belongs to the template returned.</p>

<p>The <code>document</code> parameter is optionally an explicit DOM <code>Document</code> to use
when building a template from string markup.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">DOMJuice = </span><span class="nf">(template, document) -&gt;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">template</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
    <span class="nx">unless</span> <span class="nb">document</span> <span class="o">?=</span> <span class="nx">DOMJuice</span><span class="p">.</span><span class="nb">document</span> <span class="o">?</span> <span class="nb">window</span><span class="o">?</span><span class="p">.</span><span class="nb">document</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Cannot find a DOM Document to work with&quot;</span>
    <span class="nv">tmp = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s1">&#39;div&#39;</span>
    <span class="nv">tmp.innerHTML = </span><span class="nx">template</span>
    <span class="nx">unless</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Template should have exactly one root element&quot;</span>
    <span class="nv">template = </span><span class="nx">tmp</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="k">else</span> <span class="nx">unless</span> <span class="nx">template</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">is</span> <span class="nx">ELEMENT_NODE</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Expected a DOM Element or string of HTML&quot;</span>

  <span class="k">else</span> <span class="k">if</span> <span class="nv">parentNode = </span><span class="nx">template</span><span class="p">.</span><span class="nx">parentNode</span>
    <span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">template</span>

  <span class="nx">buildSectionClass</span> <span class="nx">template</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Export as global <code>DOMJuice</code> or a CommonJS module.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="nx">module</span><span class="o">?</span><span class="p">.</span><span class="nx">exports</span><span class="o">?</span>
  <span class="nv">module.exports = </span><span class="nx">DOMJuice</span>
<span class="k">else</span>
  <span class="vi">@DOMJuice = </span><span class="nx">DOMJuice</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Export the adaptor API.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">DOMJuice.getAdaptor = </span><span class="nx">getAdaptor</span>
<span class="nv">DOMJuice.registerAdaptor = </span><span class="nx">registerAdaptor</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>The user may override this with a map of partials by name.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">DOMJuice.partials = </span><span class="p">{}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 