<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>DOMJuice Test Suite</title>

  <!-- Hide templates -->
  <style>.template { display: none }</style>

  <!-- jQuery -->
  <script src="http://code.jquery.com/jquery-latest.js"></script>

  <!-- QUnit -->
  <!-- Prevent auto-start to make it work in combination with Coffee. -->
  <link rel="stylesheet" href="http://code.jquery.com/qunit/git/qunit.css" type="text/css" media="screen">
  <script type="text/javascript" src="http://code.jquery.com/qunit/git/qunit.js"></script>
  <script>QUnit.config.autostart = false;</script>

  <!-- Backbone.js -->
  <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.1.6/underscore-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.3.3/backbone-min.js"></script>

  <!-- CoffeeScript -->
  <script src="http://jashkenas.github.com/coffee-script/extras/coffee-script.js"></script>

  <!-- DOMJuice itself -->
  <script src="domjuice.coffee" type="text/coffeescript"></script>
  <script src="domjuice-backbone.coffee" type="text/coffeescript"></script>

  <!-- Test helpers -->
  <script type="text/coffeescript">

    # Set these as globals for easy access.
    window.Model = Backbone.Model
    window.Collection = Backbone.Collection

    # Helper to quickly build and run a template constructed from an existing element.
    # Takes the element ID, the context, and returns a jQuery object for the resulting element.
    window.build = (id, context) ->
      element = $("##{id}")[0].cloneNode yes
      $(element).removeClass 'template'
      element.id = ''

      template = DOMJuice element
      instance = new template context
      $ instance.el

  </script>
</head>
<body>


  <!-- Tests follow -->

  <div id="basic-template" class="template">
    <p></p>
  </div>
  <script type="text/coffeescript">
    test 'Basic template with DOM input', ->
      res = build 'basic-template'
      ok res.find('p').length is 1, "result should match template content"

    test 'Basic template with string markup input', ->
      template = DOMJuice '<div><p></p></div>'
      instance = new template
      ok $('p', instance.el).length is 1, "result should match template content"
  </script>

  <div id="varattr-template" class="template">
    <p class:="cssClass"></p>
  </div>
  <script type="text/coffeescript">
    test 'Basic attribute operation', 2, ->
      res = build 'varattr-template', cssClass: 'foobar'
      ok res.find('p').hasClass('foobar'), "paragraph tag should have class 'foobar'"

      res = build 'varattr-template'
      ok not res.find('p').hasClass('undefined'), "paragraph tag shouldn't have class 'undefined'"

    test 'Variable attribute', 3, ->
      model = new Model cssClass: 'foobar'

      res = build 'varattr-template', model
      ok res.find('p').hasClass('foobar'), "paragraph tag should have class 'foobar'"

      model.set cssClass: 'baz'
      ok not res.find('p').hasClass('foobar'), "paragraph tag should no longer have class 'foobar'"
      ok res.find('p').hasClass('baz'), "paragraph tag should have class 'baz'"
  </script>

  <div id="varcontent-template" class="template">
    <p content:="text"></p>
  </div>
  <script type="text/coffeescript">
    test 'Basic content operation', 2, ->
      res = build 'varcontent-template', text: 'foobar'
      ok res.find('p').text() is 'foobar', "paragraph should have text foobar"

      res = build 'varcontent-template'
      ok res.find('p').text() is '', "paragraph should be empty"

    test 'Variable content', 2, ->
      model = new Model text: 'foobar'

      res = build 'varcontent-template', model
      ok res.find('p').text() is 'foobar', "paragraph should have content foobar"

      model.set text: false
      ok res.find('p').text() is '', "paragraph should be empty"
  </script>

  <div id="section-template" class="template">
    <ul>
      <li section:='items'></li>
    </ul>
  </div>
  <script type="text/coffeescript">
    test 'Basic section operation', 4, ->
      res = build 'section-template', items: [{}, {}, {}]
      ok res.find('li').length is 3, 'list should have 3 items'

      res = build 'section-template', items: {}
      ok res.find('li').length is 1, 'list should have 1 item'

      res = build 'section-template', items: true
      ok res.find('li').length is 1, 'list should have 1 item'

      res = build 'section-template', items: false
      ok res.find('li').length is 0, 'list should be empty'

    test 'Variable sized section', 4, ->
      collection = new Collection [{}, {}, {}]

      res = build 'section-template', items: collection
      ok res.find('li').length is 3, 'list should have 3 items'

      collection.add {}
      ok res.find('li').length is 4, 'list should have 4 items'

      collection.remove collection.models[1]
      ok res.find('li').length is 3, 'list should have 3 items'

      collection.refresh []
      ok res.find('li').length is 0, 'list should be empty'
  </script>

  <div id="root-ref-template" class="template">
    <p id="a1" content:="a"></p>
    <p id="b1" content:="b"></p>
    <div section:="level2">
      <p id="a2" content:="a"></p>
      <p id="b2" content:="b"></p>
      <div section:="level3">
        <p id="a3" content:="a"></p>
        <p id="b3" content:="b"></p>
      </div>
    </div>
  </div>
  <script type="text/coffeescript">
    test 'Root context reference', 6, ->
      res = build 'root-ref-template',
        a: 1, b: 2
        level2:
          a: 3
          level3:
            b: 4

      ok res.find('#a1').text() is '1', 'a1 should contain 1'
      ok res.find('#b1').text() is '2', 'b1 should contain 2'
      ok res.find('#a2').text() is '3', 'a2 should contain 3'
      ok res.find('#b2').text() is '2', 'b2 should contain 2'
      ok res.find('#a3').text() is '1', 'a3 should contain 1'
      ok res.find('#b3').text() is '4', 'b3 should contain 4'
  </script>


  <!-- QUnit boilerplate -->
  <h1 id="qunit-header">DOMJuice Test Suite</h1>
  <h2 id="qunit-banner"></h2>
  <div id="qunit-testrunner-toolbar"></div>
  <h2 id="qunit-userAgent"></h2>
  <ol id="qunit-tests"></ol>
  <div id="qunit-fixture"></div>
  <script type="text/coffeescript">QUnit.start()</script>

</body>
</html>
